<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - BonkFaucet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        const DATABASE_CONFIG = {
            BIN_ID: "67b0a195ad19ca34f804ba90",
            API_KEY: "$2a$10$m3ykh1NKxmtQDVM140H6TOTqsemkiBEdfdQnG/ApyhjJ1Duj2Ri6W",
            BASE_URL: "https://api.jsonbin.io/v3/b"
        };

        // Authentication Check
        function checkAdminAuth() {
            const adminSession = JSON.parse(localStorage.getItem('adminSession') || '{}');
            if (!adminSession.isAdmin || adminSession.sessionExpiry < new Date().getTime()) {
                localStorage.removeItem('adminSession');
                window.location.href = '/admin-login.html';
            }
        }

        // Data Management Functions
        async function fetchData() {
            try {
                const response = await fetch(`${DATABASE_CONFIG.BASE_URL}/${DATABASE_CONFIG.BIN_ID}/latest`, {
                    headers: {
                        'X-Master-Key': DATABASE_CONFIG.API_KEY
                    }
                });
                return (await response.json()).record;
            } catch (error) {
                console.error('Error fetching data:', error);
                showNotification('Failed to fetch data', true);
                return null;
            }
        }

        async function updateData(newData) {
            try {
                await fetch(`${DATABASE_CONFIG.BASE_URL}/${DATABASE_CONFIG.BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': DATABASE_CONFIG.API_KEY
                    },
                    body: JSON.stringify(newData)
                });
                showNotification('Data updated successfully');
            } catch (error) {
                console.error('Error updating data:', error);
                showNotification('Failed to update data', true);
            }
        }

        // Shortlink Management
        async function addShortlink() {
            const url = document.getElementById('shortlink-url').value;
            const reward = parseFloat(document.getElementById('shortlink-reward').value);
            const dailyLimit = parseInt(document.getElementById('shortlink-daily-limit').value);

            if (!url || isNaN(reward) || isNaN(dailyLimit)) {
                showNotification('Please fill all fields correctly', true);
                return;
            }

            const data = await fetchData();
            if (!data) return;

            const newShortlink = {
                id: crypto.randomUUID(),
                url,
                reward,
                views: 0,
                dailyLimit,
                remainingDailyViews: dailyLimit,
                lastReset: new Date().toISOString(),
                active: true,
                createdAt: new Date().toISOString()
            };

            data.shortlinks.push(newShortlink);
            await updateData(data);
            loadShortlinks();
            clearShortlinkForm();
        }

        async function toggleShortlink(id) {
            const data = await fetchData();
            if (!data) return;

            const shortlink = data.shortlinks.find(s => s.id === id);
            if (shortlink) {
                shortlink.active = !shortlink.active;
                await updateData(data);
                loadShortlinks();
            }
        }

        async function deleteShortlink(id) {
            if (!confirm('Are you sure you want to delete this shortlink?')) return;

            const data = await fetchData();
            if (!data) return;

            data.shortlinks = data.shortlinks.filter(s => s.id !== id);
            await updateData(data);
            loadShortlinks();
        }

        // PTC Ads Management
        async function addPtcAd() {
            const title = document.getElementById('ptc-title').value;
            const url = document.getElementById('ptc-url').value;
            const reward = parseFloat(document.getElementById('ptc-reward').value);
            const duration = parseInt(document.getElementById('ptc-duration').value);
            const dailyLimit = parseInt(document.getElementById('ptc-daily-limit').value);

            if (!title || !url || isNaN(reward) || isNaN(duration) || isNaN(dailyLimit)) {
                showNotification('Please fill all fields correctly', true);
                return;
            }

            const data = await fetchData();
            if (!data) return;

            const newAd = {
                id: crypto.randomUUID(),
                title,
                url,
                reward,
                duration,
                dailyLimit,
                remainingViews: dailyLimit,
                active: true,
                createdAt: new Date().toISOString()
            };

            data.ptcAds.push(newAd);
            await updateData(data);
            loadPtcAds();
            clearPtcForm();
        }

        async function togglePtcAd(id) {
            const data = await fetchData();
            if (!data) return;

            const ad = data.ptcAds.find(a => a.id === id);
            if (ad) {
                ad.active = !ad.active;
                await updateData(data);
                loadPtcAds();
            }
        }

        async function deletePtcAd(id) {
            if (!confirm('Are you sure you want to delete this PTC ad?')) return;

            const data = await fetchData();
            if (!data) return;

            data.ptcAds = data.ptcAds.filter(a => a.id !== id);
            await updateData(data);
            loadPtcAds();
        }

        // User Management
        async function loadUsers() {
            const data = await fetchData();
            if (!data) return;

            const container = document.getElementById('users-container');
            container.innerHTML = data.users.map(user => `
                <div class="bg-gray-800 p-4 rounded-lg shadow-md mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <h3 class="text-lg font-medium">${user.username}</h3>
                            <p class="text-gray-400">Email: ${user.email}</p>
                            <p class="text-gray-400">Wallet: ${user.phantomWallet}</p>
                            <p class="text-purple-500">Balance: ${user.balance.bonk} BONK / ${user.balance.usdt} USDT</p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="editUserBalance('${user.id}')"
                                class="bg-blue-600 hover:bg-blue-700 px-3 py-1 rounded-md text-sm">
                                Edit Balance
                            </button>
                            <button onclick="toggleUserStatus('${user.id}')"
                                class="bg-yellow-600 hover:bg-yellow-700 px-3 py-1 rounded-md text-sm">
                                ${user.active ? 'Disable' : 'Enable'}
                            </button>
                            <button onclick="deleteUser('${user.id}')"
                                class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md text-sm">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function editUserBalance(userId) {
            const bonkAmount = prompt('Enter new BONK balance:');
            if (bonkAmount === null) return;

            const data = await fetchData();
            if (!data) return;

            const user = data.users.find(u => u.id === userId);
            if (user) {
                user.balance.bonk = parseFloat(bonkAmount);
                await updateData(data);
                loadUsers();
            }
        }

        async function toggleUserStatus(userId) {
            const data = await fetchData();
            if (!data) return;

            const user = data.users.find(u => u.id === userId);
            if (user) {
                user.active = !user.active;
                await updateData(data);
                loadUsers();
            }
        }

        async function deleteUser(userId) {
            if (!confirm('Are you sure you want to delete this user?')) return;

            const data = await fetchData();
            if (!data) return;

            data.users = data.users.filter(u => u.id !== userId);
            await updateData(data);
            loadUsers();
        }

        // Statistics
        async function loadStatistics() {
            const data = await fetchData();
            if (!data) return;

            const stats = data.statistics;
            document.getElementById('total-users').textContent = stats.totalUsers;
            document.getElementById('total-claims').textContent = stats.totalClaims;
            document.getElementById('total-paid').textContent = stats.totalPaid;
            document.getElementById('total-deposited').textContent = stats.totalDeposited;
        }

        // UI Helpers
        function showNotification(message, isError = false) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-md ${
                isError ? 'bg-red-600' : 'bg-green-600'
            }`;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function clearShortlinkForm() {
            document.getElementById('shortlink-url').value = '';
            document.getElementById('shortlink-reward').value = '';
            document.getElementById('shortlink-daily-limit').value = '';
        }

        function clearPtcForm() {
            document.getElementById('ptc-title').value = '';
            document.getElementById('ptc-url').value = '';
            document.getElementById('ptc-reward').value = '';
            document.getElementById('ptc-duration').value = '';
            document.getElementById('ptc-daily-limit').value = '';
        }

        // Tab Management
        function switchTab(tabId) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Show selected tab
            document.getElementById(tabId).classList.remove('hidden');
            
            // Update active tab style
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-purple-600');
                button.classList.add('bg-gray-700');
            });
            document.querySelector(`[onclick="switchTab('${tabId}')"]`).classList.add('bg-purple-600');
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAdminAuth();
            loadStatistics();
            loadUsers();
            switchTab('dashboard-tab');
        });
    </script>
</head>
<body class="bg-gray-900 text-white">
    <!-- Navigation -->
    <nav class="bg-gray-800 border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <img class="h-12 w-12" src="/images/logo.png" alt="BonkFaucet Logo">
                    </div>
                    <div class="ml-4 text-lg font-bold">Admin Panel</div>
                </div>
                <div class="flex items-center">
                    <button onclick="localStorage.removeItem('adminSession'); window.location.href='/admin-login.html'"
                        class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-md text-sm font-medium">
                        Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Tabs -->
        <div class="flex space-x-4 mb-8">
            <button onclick="switchTab('dashboard-tab')"
                class="tab-button bg-purple-600 px-4 py-2 rounded-md text-sm font-medium">
                Dashboard
            </button>
            <button onclick="switchTab('shortlinks-tab')"
                class="tab-button bg-gray-700 px-4 py-2 rounded-md text-sm font-medium">
                Shortlinks
            </button>
            <button onclick="switchTab('ptc-tab')"
                class="tab-button bg-gray-700 px-4 py-2 rounded-md text-sm font-medium">
                PTC Ads
            </button>
            <button onclick="switchTab('users-tab')"
                class="tab-button bg-gray-700 px-4 py-2 rounded-md text-sm font-medium">
                Users
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard-tab" class="tab-content">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium mb-2">Total Users</h3>
                    <p class="text-3xl font-bold text-purple-500" id="total-users">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium mb-2">Total Claims</h3>
                    <p class="text-3xl font-bold text-purple-500" id="total-claims">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium mb-2">Total Paid (BONK)</h3>
                    <p class="text-3xl font-bold text-purple-500" id="total-paid">0</p>
                </div>
                <div class="bg-gray-800 p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-medium mb-2">Total Deposite</h3>
                    <p class="text-3xl font-bold text-purple-500" id="total-deposited">0</p>
                </div>
            </div>
        </div>

        <!-- Shortlinks Tab -->
        <div id="shortlinks-tab" class="tab-content hidden">
            <!-- Add Shortlink Form -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-lg font-medium mb-4">Add New Shortlink</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">URL</label>
                        <input type="text" id="shortlink-url"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Reward (BONK)</label>
                        <input type="number" id="shortlink-reward"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Daily Limit</label>
                        <input type="number" id="shortlink-daily-limit"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                    </div>
                </div>
                <button onclick="addShortlink()"
                    class="mt-4 bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-md font-medium">
                    Add Shortlink
                </button>
            </div>

            <!-- Shortlinks List -->
            <div id="shortlinks-container" class="space-y-4">
                <!-- Shortlinks will be loaded here -->
            </div>
        </div>

        <!-- PTC Ads Tab -->
        <div id="ptc-tab" class="tab-content hidden">
            <!-- Add PTC Ad Form -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-lg font-medium mb-4">Add New PTC Ad</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Title</label>
                        <input type="text" id="ptc-title"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">URL</label>
                        <input type="text" id="ptc-url"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Reward (BONK)</label>
                        <input type="number" id="ptc-reward"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Duration (seconds)</label>
                        <input type="number" id="ptc-duration"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Daily View Limit</label>
                        <input type="number" id="ptc-daily-limit"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                    </div>
                </div>
                <button onclick="addPtcAd()"
                    class="mt-4 bg-purple-600 hover:bg-purple-700 px-6 py-2 rounded-md font-medium">
                    Add PTC Ad
                </button>
            </div>

            <!-- PTC Ads List -->
            <div id="ptc-ads-container" class="space-y-4">
                <!-- PTC Ads will be loaded here -->
            </div>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="tab-content hidden">
            <!-- Search and Filter -->
            <div class="bg-gray-800 p-6 rounded-lg shadow-md mb-8">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Search Users</label>
                        <input type="text" id="user-search"
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full"
                            placeholder="Search by username or email">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Sort By</label>
                        <select id="user-sort" 
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                            <option value="username">Username</option>
                            <option value="balance">Balance</option>
                            <option value="joined">Join Date</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-400 mb-2">Filter Status</label>
                        <select id="user-filter" 
                            class="bg-gray-700 border border-gray-600 rounded-md px-4 py-2 w-full">
                            <option value="all">All Users</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Users List -->
            <div id="users-container" class="space-y-4">
                <!-- Users will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Export Data Modal -->
    <div id="export-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-gray-800 p-6 rounded-lg shadow-md max-w-md w-full">
            <h3 class="text-lg font-medium mb-4">Export Data</h3>
            <div class="space-y-4">
                <label class="block">
                    <input type="checkbox" class="mr-2" value="users">
                    Users Data
                </label>
                <label class="block">
                    <input type="checkbox" class="mr-2" value="transactions">
                    Transactions
                </label>
                <label class="block">
                    <input type="checkbox" class="mr-2" value="statistics">
                    Statistics
                </label>
            </div>
            <div class="mt-6 flex justify-end space-x-4">
                <button onclick="closeExportModal()"
                    class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-md">
                    Cancel
                </button>
                <button onclick="exportData()"
                    class="bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-md">
                    Export
                </button>
            </div>
        </div>
    </div>

    <!-- Additional JavaScript Functions -->
    <script>
        // Export Functions
        function openExportModal() {
            document.getElementById('export-modal').classList.remove('hidden');
        }

        function closeExportModal() {
            document.getElementById('export-modal').classList.add('hidden');
        }

        async function exportData() {
            const data = await fetchData();
            if (!data) return;

            const selectedData = {
                exportDate: new Date().toISOString(),
                data: {}
            };

            document.querySelectorAll('#export-modal input[type="checkbox"]:checked').forEach(checkbox => {
                selectedData.data[checkbox.value] = data[checkbox.value];
            });

            const blob = new Blob([JSON.stringify(selectedData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `bonkfaucet_export_${new Date().toISOString()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            closeExportModal();
            showNotification('Data exported successfully');
        }

        // Withdrawal Management
        async function loadPendingWithdrawals() {
            const data = await fetchData();
            if (!data) return;

            const pendingWithdrawals = data.users.reduce((acc, user) => {
                const pending = user.withdrawals.filter(w => w.status === 'pending');
                return [...acc, ...pending.map(w => ({ ...w, username: user.username, userId: user.id }))];
            }, []);

            const container = document.getElementById('pending-withdrawals');
            container.innerHTML = pendingWithdrawals.map(withdrawal => `
                <div class="bg-gray-800 p-4 rounded-lg shadow-md mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <p class="font-medium">${withdrawal.username}</p>
                            <p class="text-gray-400">Amount: ${withdrawal.amount} BONK</p>
                            <p class="text-gray-400">Requested: ${new Date(withdrawal.timestamp).toLocaleString()}</p>
                        </div>
                        <div class="space-x-2">
                            <button onclick="processWithdrawal('${withdrawal.userId}', '${withdrawal.id}', true)"
                                class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded-md text-sm">
                                Approve
                            </button>
                            <button onclick="processWithdrawal('${withdrawal.userId}', '${withdrawal.id}', false)"
                                class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded-md text-sm">
                                Reject
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        async function processWithdrawal(userId, withdrawalId, approve) {
            const data = await fetchData();
            if (!data) return;

            const user = data.users.find(u => u.id === userId);
            if (!user) return;

            const withdrawal = user.withdrawals.find(w => w.id === withdrawalId);
            if (!withdrawal) return;

            withdrawal.status = approve ? 'completed' : 'rejected';
            if (!approve) {
                user.balance.bonk += withdrawal.amount; // Refund if rejected
            }

            await updateData(data);
            loadPendingWithdrawals();
            showNotification(`Withdrawal ${approve ? 'approved' : 'rejected'} successfully`);
        }

        // Initialize additional features
        document.addEventListener('DOMContentLoaded', () => {
            loadPendingWithdrawals();
        });
    </script>
</body>
</html>
