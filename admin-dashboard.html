<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BONK Admin Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="database.js"></script>
    <style>
        body {
            background: #0f172a;
            color: #e2e8f0;
        }
        .modal {
            background: rgba(0,0,0,0.5);
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 p-8">
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-white text-center">BONK Admin Dashboard</h1>

        <!-- Global Statistics -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-400">Toplam İstatistikler</h2>
                <div id="globalStats">
                    <p>Toplam Kullanıcı: <span id="totalUsers">-</span></p>
                    <p>Toplam BONK: <span id="totalBonk">-</span></p>
                </div>
            </div>
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-400">Oyun İstatistikleri</h2>
                <div id="gameStats">
                    <p>Flappy Bird Toplam Oyun: <span id="flappyPlays">-</span></p>
                    <p>Dino Runner Toplam Oyun: <span id="dinoPlays">-</span></p>
                    <p>Clicker Toplam Tıklama: <span id="clickerClicks">-</span></p>
                </div>
            </div>
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-purple-400">Referans İstatistikleri</h2>
                <div id="referralStats">
                    <p>Toplam Referans: <span id="totalReferrals">-</span></p>
                    <h3 class="mt-4 mb-2 font-semibold">En İyi 3 Referansçı</h3>
                    <ul id="topReferrers"></ul>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Shortlinks Section -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-400">Shortlinks Yönetimi</h2>
                <button onclick="openModal('shortlinkModal')" class="w-full bg-indigo-600 text-white py-2 rounded mb-4">
                    Yeni Shortlink Ekle
                </button>
                <div id="shortlinksList" class="space-y-2">
                    <!-- Dinamik shortlink listesi -->
                </div>
            </div>

            <!-- PTC Ads Section -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-400">PTC Reklam Yönetimi</h2>
                <button onclick="openModal('ptcAdModal')" class="w-full bg-green-600 text-white py-2 rounded mb-4">
                    Yeni PTC Reklam Ekle
                </button>
                <div id="ptcAdsList" class="space-y-2">
                    <!-- Dinamik PTC reklam listesi -->
                </div>
            </div>

            <!-- Tasks Section -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-purple-400">Görev Yönetimi</h2>
                <button onclick="openModal('taskModal')" class="w-full bg-purple-600 text-white py-2 rounded mb-4">
                    Yeni Görev Ekle
                </button>
                <div id="tasksList" class="space-y-2">
                    <!-- Dinamik görev listesi -->
                </div>
            </div>
        </div>
    </div>

    <!-- Shortlink Modal -->
    <div id="shortlinkModal" class="fixed inset-0 z-50 modal items-center justify-center">
        <div class="bg-slate-700 rounded-lg p-8 w-96">
            <h3 class="text-xl font-semibold mb-4">Yeni Shortlink Ekle</h3>
            <form id="shortlinkForm">
                <input type="text" placeholder="Shortlink Başlığı" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <input type="url" placeholder="Shortlink URL" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <input type="number" placeholder="BONK Ödülü" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <div class="flex justify-between">
                    <button type="button" onclick="closeModal('shortlinkModal')" 
                        class="bg-slate-500 text-white py-2 px-4 rounded">İptal</button>
                    <button type="submit" 
                        class="bg-indigo-600 text-white py-2 px-4 rounded">Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PTC Ad Modal -->
    <div id="ptcAdModal" class="fixed inset-0 z-50 modal items-center justify-center">
        <div class="bg-slate-700 rounded-lg p-8 w-96">
            <h3 class="text-xl font-semibold mb-4">Yeni PTC Reklam Ekle</h3>
            <form id="ptcAdForm">
                <input type="text" placeholder="Reklam Başlığı" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <input type="url" placeholder="Reklam URL" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <input type="number" placeholder="Görüntüleme Başına BONK" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <div class="flex justify-between">
                    <button type="button" onclick="closeModal('ptcAdModal')" 
                        class="bg-slate-500 text-white py-2 px-4 rounded">İptal</button>
                    <button type="submit" 
                        class="bg-green-600 text-white py-2 px-4 rounded">Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 z-50 modal items-center justify-center">
        <div class="bg-slate-700 rounded-lg p-8 w-96">
            <h3 class="text-xl font-semibold mb-4">Yeni Görev Ekle</h3>
            <form id="taskForm">
                <input type="text" placeholder="Görev Başlığı" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <textarea placeholder="Görev Açıklaması" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded"></textarea>
                <input type="number" placeholder="BONK Ödülü" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <select class="w-full p-2 mb-4 bg-slate-600 rounded">
                    <option value="">Görev Türü Seçin</option>
                    <option value="social">Sosyal Medya</option>
                    <option value="website">Web Sitesi</option>
                    <option value="video">Video</option>
                    <option value="other">Diğer</option>
                </select>
                <div class="flex justify-between">
                    <button type="button" onclick="closeModal('taskModal')" 
                        class="bg-slate-500 text-white py-2 px-4 rounded">İptal</button>
                    <button type="submit" 
                        class="bg-purple-600 text-white py-2 px-4 rounded">Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Admin Ayarları (Güvenli bir şekilde saklanmalı)
        const ADMIN_CONFIG = {
            email: 'admin@bonkcoin.com',
            password: 'bonk2024admin!'
        };

        // Modal Yönetimi
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Global İstatistikleri Güncelleme
        async function updateGlobalStats() {
            try {
                const stats = await DATABASE.stats.getGlobalStats();
                if (stats) {
                    // Toplam İstatistikler
                    document.getElementById('totalUsers').textContent = stats.totalUsers.toLocaleString();
                    document.getElementById('totalBonk').textContent = stats.totalBonk.toLocaleString();

                    // Oyun İstatistikleri
                    document.getElementById('flappyPlays').textContent = stats.gameStats.flappyBird.totalPlays.toLocaleString();
                    document.getElementById('dinoPlays').textContent = stats.gameStats.dinoRunner.totalPlays.toLocaleString();
                    document.getElementById('clickerClicks').textContent = stats.gameStats.clicker.totalClicks.toLocaleString();

                    // Referans İstatistikleri
                    document.getElementById('totalReferrals').textContent = stats.referralStats.totalReferrals.toLocaleString();

                    // En İyi Referansçılar
                    const topReferrersList = document.getElementById('topReferrers');
                    topReferrersList.innerHTML = stats.referralStats.topReferrers
                        .slice(0, 3)
                        .map(referrer => `<li>Kullanıcı ${referrer.userId}: ${referrer.referralCount} referans</li>`)
                        .join('');
                }
            } catch (error) {
                console.error('Global stats update error:', error);
            }
        }

        // Leaderboard Yükleme
        async function loadLeaderboards() {
            try {
                const boards = [
                    { type: 'flappyBird', elementId: 'flappyLeaderboard' },
                    { type: 'dinoRunner', elementId: 'dinoLeaderboard' },
                    { type: 'clicker', elementId: 'clickerLeaderboard' },
                    { type: 'bonkBalance', elementId: 'bonkLeaderboard' }
                ];

                for (const board of boards) {
                    const leaderboard = await DATABASE.stats.getLeaderboard(board.type);
                    const element = document.getElementById(board.elementId);
                    if (element && leaderboard) {
                        element.innerHTML = leaderboard
                            .slice(0, 5)
                            .map((entry, index) => `
                                <li class="flex justify-between">
                                    <span>${index + 1}. Kullanıcı ${entry.userId}</span>
                                    <span>${entry.score || entry.clicks || entry.balance || 0}</span>
                                </li>
                            `)
                            .join('');
                    }
                }
            } catch (error) {
                console.error('Leaderboard load error:', error);
            }
        }

        // Veri Yönetimi Fonksiyonları
        const dataManagement = {
            async addShortlink(title, url, bonkReward) {
                try {
                    const data = await DATABASE.api.getAllData();
                    if (!data.shortlinks) data.shortlinks = [];

                    data.shortlinks.push({
                        id: Date.now(),
                        title,
                        url,
                        bonkReward: parseInt(bonkReward)
                    });

                    await DATABASE.api.updateData(data);
                    this.renderShortlinks(data.shortlinks);
                } catch (error) {
                    console.error('Shortlink ekleme hatası:', error);
                }
            },

            async addPtcAd(title, url, bonkPerView) {
                try {
                    const data = await DATABASE.api.getAllData();
                    if (!data.ptcAds) data.ptcAds = [];

                    data.ptcAds.push({
                        id: Date.now(),
                        title,
                        url,
                        bonkPerView: parseInt(bonkPerView)
                    });

                    await DATABASE.api.updateData(data);
                    this.renderPtcAds(data.ptcAds);
                } catch (error) {
                    console.error('PTC reklam ekleme hatası:', error);
                }
            },

            async addTask(title, description, bonkReward, type) {
                try {
                    const data = await DATABASE.api.getAllData();
                    if (!data.tasks) data.tasks = [];

                    data.tasks.push({
                        id: Date.now(),
                        title,
                        description,
                        bonkReward: parseInt(bonkReward),
                        type
                    });

                    await DATABASE.api.updateData(data);
                    this.renderTasks(data.tasks);
                } catch (error) {
                    console.error('Görev ekleme hatası:', error);
                }
            },

            async renderShortlinks(shortlinks = []) {
                const list = document.getElementById('shortlinksList');
                list.innerHTML = shortlinks.length ? 
                    shortlinks.map(sl => `
                        <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${sl.title}</p>
                                <p class="text-sm text-slate-400">${sl.bonkReward} BONK - ${sl.url}</p>
                            </div>
                            <button onclick="dataManagement.deleteShortlink(${sl.id})" 
                                class="bg-red-500 text-white px-2 py-1 rounded text-sm">
                                Sil
                            </button>
                        </div>
                    `).join('') : 
                    '<p class="text-slate-500 text-center">Henüz shortlink yok</p>';
            },

            async renderPtcAds(ptcAds = []) {
                const list = document.getElementById('ptcAdsList');
                list.innerHTML = ptcAds.length ? 
                    ptcAds.map(ad => `
                        <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${ad.title}</p>
                                <p class="text-sm text-slate-400">Görüntüleme Başına ${ad.bonkPerView} BONK - ${ad.url}</p>
                            </div>
                            <button onclick="dataManagement.deletePtcAd(${ad.id})" 
                                class="bg-red-500 text-white px-2 py-1 rounded text-sm">
                                Sil
                            </button>
                        </div>
                    `).join('') : 
                    '<p class="text-slate-500 text-center">Henüz PTC reklam yok</p>';
            },

            async renderTasks(tasks = []) {
                const list = document.getElementById('tasksList');
                list.innerHTML = tasks.length ? 
                    tasks.map(task => `
                        <div class="bg-slate-700 p-3 rounded flex justify-between items-center">
                            <div>
                                <p class="font-semibold">${task.title}</p>
                                <p class="text-sm text-slate-400">${task.bonkReward} BONK - ${task.type}</p>
                                <p class="text-xs text-slate-500">${task.description}</p>
                            </div>
                            <button onclick="dataManagement.deleteTask(${task.id})" 
                                class="bg-red-500 text-white px-2 py-1 rounded text-sm">
                                Sil
                            </button>
                        </div>
                    `).join('') : 
                    '<p class="text-slate-500 text-center">Henüz görev yok</p>';
            },

            async deleteShortlink(id) {
                try {
                    const data = await DATABASE.api.getAllData();
                    if (data.shortlinks) {
                        data.shortlinks = data.shortlinks.filter(sl => sl.id !== id);
                        await DATABASE.api.updateData(data);
                        this.renderShortlinks(data.shortlinks);
                    }
                } catch (error) {
                    console.error('Shortlink silme hatası:', error);
                }
            },

            async deletePtcAd(id) {
                try {
                    const data = await DATABASE.api.getAllData();
                    if (data.ptcAds) {
                        data.ptcAds = data.ptcAds.filter(ad => ad.id !== id);
                        await DATABASE.api.updateData(data);
                        this.renderPtcAds(data.ptcAds);
                    }
                } catch (error) {
                    console.error('PTC reklam silme hatası:', error);
                }
            },

            async deleteTask(id) {
                try {
                    const data = await DATABASE.api.getAllData();
                    if (data.tasks) {
                        data.tasks = data.tasks.filter(task => task.id !== id);
                        await DATABASE.api.updateData(data);
                        this.renderTasks(data.tasks);
                    }
                } catch (error) {
                    console.error('Görev silme hatası:', error);
                }
            },

            async loadInitialData() {
                try {
                    const data = await DATABASE.api.getAllData();
                    
                    // İlk yüklemede varolan verileri render et
                    this.renderShortlinks(data.shortlinks || []);
                    this.renderPtcAds(data.ptcAds || []);
                    this.renderTasks(data.tasks || []);
                } catch (error) {
                    console.error('Başlangıç verilerini yükleme hatası:', error);
                }
            }
        };

        // Form Gönderim İşleyicileri
        document.getElementById('shortlinkForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = this.querySelector('input[type="text"]').value;
            const url = this.querySelector('input[type="url"]').value;
            const bonkReward = this.querySelector('input[type="number"]').value;

            await dataManagement.addShortlink(title, url, bonkReward);
            closeModal('shortlinkModal');
            this.reset();
        });

        document.getElementById('ptcAdForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = this.querySelector('input[type="text"]').value;
            const url = this.querySelector('input[type="url"]').value;
            const bonkPerView = this.querySelector('input[type="number"]').value;

            await dataManagement.addPtcAd(title, url, bonkPerView);
            closeModal('ptcAdModal');
            this.reset();
        });

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = this.querySelector('input[type="text"]').value;
            const description = this.querySelector('textarea').value;
            const bonkReward = this.querySelector('input[type="number"]').value;
            const type = this.querySelector('select').value;

            await dataManagement.addTask(title, description, bonkReward, type);
            closeModal('taskModal');
            this.reset();
        });

        // Sayfa Yükleme İşlemleri
        document.addEventListener('DOMContentLoaded', async () => {
            // Giriş kontrolü
            const isLoggedIn = localStorage.getItem('adminAuth') === 'true';
            if (!isLoggedIn) {
                window.location.href = '/admin.html';
                return;
            }

            // Verileri yükle
            await dataManagement.loadInitialData();
            
            // İstatistikleri güncelle
            await updateGlobalStats();
            await loadLeaderboards();

            // Periyodik olarak istatistikleri güncelle
            setInterval(updateGlobalStats, 5 * 60 * 1000); // 5 dakikada bir
        });

        // Çıkış İşlemi
        function logout() {
            localStorage.removeItem('adminAuth');
            window.location.href = '/admin.html';
        }
    </script>
</body>
</html>
