<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BONK Coin Admin Yönetim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="database.js"></script>
    <style>
        body {
            background: #0f172a;
            color: #e2e8f0;
        }
        .modal {
            background: rgba(0,0,0,0.5);
            display: none;
        }
    </style>
</head>
<body class="min-h-screen bg-slate-900 p-8">
    <div class="container mx-auto">
        <h1 class="text-3xl font-bold mb-8 text-white text-center">BONK Coin Admin Yönetim Paneli</h1>

        <!-- Kullanıcı Yönetimi Bölümü -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-400">Kullanıcı Yönetimi</h2>
                <div class="space-y-4">
                    <button onclick="openModal('userFilterModal')" class="w-full bg-indigo-600 text-white py-2 rounded">
                        Kullanıcı Filtrele
                    </button>
                    <button onclick="openModal('userDetailsModal')" class="w-full bg-green-600 text-white py-2 rounded">
                        Kullanıcı Detayları
                    </button>
                </div>
            </div>

            <!-- Günlük Limitler Bölümü -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-400">Günlük Limitler</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span>Günlük Shortlink Çözme Limiti:</span>
                        <input type="number" id="dailyShortlinkLimit" value="10" 
                            class="w-20 p-1 bg-slate-700 rounded text-right">
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Günlük PTC Ad İzleme Limiti:</span>
                        <input type="number" id="dailyPtcAdLimit" value="15" 
                            class="w-20 p-1 bg-slate-700 rounded text-right">
                    </div>
                    <button onclick="saveDailyLimits()" class="w-full bg-purple-600 text-white py-2 rounded mt-2">
                        Limitleri Kaydet
                    </button>
                </div>
            </div>

            <!-- Sistem Ayarları -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-red-400">Sistem Ayarları</h2>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span>Airdrop Durumu:</span>
                        <select id="airdropStatus" class="bg-slate-700 p-1 rounded">
                            <option value="active">Aktif</option>
                            <option value="paused">Duraklatılmış</option>
                            <option value="ended">Sonlandırılmış</option>
                        </select>
                    </div>
                    <div class="flex justify-between items-center">
                        <span>Minimum Çekim Tutarı:</span>
                        <input type="number" id="minWithdrawAmount" value="1000" 
                            class="w-20 p-1 bg-slate-700 rounded text-right">
                    </div>
                    <button onclick="saveSystemSettings()" class="w-full bg-red-600 text-white py-2 rounded mt-2">
                        Ayarları Kaydet
                    </button>
                </div>
            </div>
        </div>

        <!-- İçerik Yönetimi -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <!-- Shortlink Yönetimi -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-indigo-400">Shortlink Yönetimi</h2>
                <button onclick="openModal('shortlinkModal')" class="w-full bg-indigo-600 text-white py-2 rounded mb-4">
                    Yeni Shortlink Ekle
                </button>
                <div id="shortlinksList" class="space-y-2">
                    <!-- Dinamik shortlink listesi -->
                </div>
            </div>

            <!-- PTC Reklam Yönetimi -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-green-400">PTC Reklam Yönetimi</h2>
                <button onclick="openModal('ptcAdModal')" class="w-full bg-green-600 text-white py-2 rounded mb-4">
                    Yeni PTC Reklam Ekle
                </button>
                <div id="ptcAdsList" class="space-y-2">
                    <!-- Dinamik PTC reklam listesi -->
                </div>
            </div>

            <!-- Görev Yönetimi -->
            <div class="bg-slate-800 rounded-lg p-6">
                <h2 class="text-2xl font-semibold mb-4 text-purple-400">Görev Yönetimi</h2>
                <button onclick="openModal('taskModal')" class="w-full bg-purple-600 text-white py-2 rounded mb-4">
                    Yeni Görev Ekle
                </button>
                <div id="tasksList" class="space-y-2">
                    <!-- Dinamik görev listesi -->
                </div>
            </div>
        </div>

        <!-- İstatistik Grafikleri -->
        <div class="mt-8 bg-slate-800 rounded-lg p-6">
            <h2 class="text-2xl font-semibold mb-4 text-blue-400">Platform İstatistikleri</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <canvas id="userGrowthChart"></canvas>
                </div>
                <div>
                    <canvas id="earningsChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Shortlink Modal -->
    <div id="shortlinkModal" class="fixed inset-0 z-50 modal items-center justify-center">
        <div class="bg-slate-700 rounded-lg p-8 w-96">
            <h3 class="text-xl font-semibold mb-4">Yeni Shortlink Ekle</h3>
            <form id="shortlinkForm">
                <input type="text" placeholder="Shortlink Başlığı" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <input type="url" placeholder="Shortlink URL" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <input type="number" placeholder="BONK Ödülü" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <div class="flex justify-between">
                    <button type="button" onclick="closeModal('shortlinkModal')" 
                        class="bg-slate-500 text-white py-2 px-4 rounded">İptal</button>
                    <button type="submit" 
                        class="bg-indigo-600 text-white py-2 px-4 rounded">Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- PTC Ad Modal -->
    <div id="ptcAdModal" class="fixed inset-0 z-50 modal items-center justify-center">
        <div class="bg-slate-700 rounded-lg p-8 w-96">
            <h3 class="text-xl font-semibold mb-4">Yeni PTC Reklam Ekle</h3>
            <form id="ptcAdForm">
                <input type="text" placeholder="Reklam Başlığı" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <input type="url" placeholder="Reklam URL" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <input type="number" placeholder="Görüntüleme Başına BONK" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <div class="flex justify-between">
                    <button type="button" onclick="closeModal('ptcAdModal')" 
                        class="bg-slate-500 text-white py-2 px-4 rounded">İptal</button>
                    <button type="submit" 
                        class="bg-green-600 text-white py-2 px-4 rounded">Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal -->
    <div id="taskModal" class="fixed inset-0 z-50 modal items-center justify-center">
        <div class="bg-slate-700 rounded-lg p-8 w-96">
            <h3 class="text-xl font-semibold mb-4">Yeni Görev Ekle</h3>
            <form id="taskForm">
                <input type="text" placeholder="Görev Başlığı" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <textarea placeholder="Görev Açıklaması" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded"></textarea>
                <input type="number" placeholder="BONK Ödülü" required 
                    class="w-full p-2 mb-4 bg-slate-600 rounded">
                <select class="w-full p-2 mb-4 bg-slate-600 rounded">
                    <option value="">Görev Türü Seçin</option>
                    <option value="social">Sosyal Medya</option>
                    <option value="website">Web Sitesi</option>
                    <option value="video">Video</option>
                    <option value="other">Diğer</option>
                </select>
                <div class="flex justify-between">
                    <button type="button" onclick="closeModal('taskModal')" 
                        class="bg-slate-500 text-white py-2 px-4 rounded">İptal</button>
                    <button type="submit" 
                        class="bg-purple-600 text-white py-2 px-4 rounded">Ekle</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Admin Yönetim Fonksiyonları
        const ADMIN_CONFIG = {
            dailyShortlinkLimit: 10,
            dailyPtcAdLimit: 15,
            systemSettings: {
                airdropStatus: 'active',
                minWithdrawAmount: 1000
            }
        };

        // Modal Yönetimi
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Günlük Limit Kaydetme
        function saveDailyLimits() {
            const shortlinkLimit = document.getElementById('dailyShortlinkLimit').value;
            const ptcAdLimit = document.getElementById('dailyPtcAdLimit').value;

            ADMIN_CONFIG.dailyShortlinkLimit = parseInt(shortlinkLimit);
            ADMIN_CONFIG.dailyPtcAdLimit = parseInt(ptcAdLimit);

            // Veritabanına kaydetme
            DATABASE.config.dailyLimits = {
                shortlink: ADMIN_CONFIG.dailyShortlinkLimit,
                ptcAd: ADMIN_CONFIG.dailyPtcAdLimit
            };

            alert('Günlük limitler başarıyla güncellendi!');
        }

        // Sistem Ayarları Kaydetme
        function saveSystemSettings() {
            const airdropStatus = document.getElementById('airdropStatus').value;
            const minWithdrawAmount = document.getElementById('minWithdrawAmount').value;

            ADMIN_CONFIG.systemSettings.airdropStatus = airdropStatus;
            ADMIN_CONFIG.systemSettings.minWithdrawAmount = parseInt(minWithdrawAmount);

            // Veritabanına kaydetme
            DATABASE.config.systemSettings = ADMIN_CONFIG.systemSettings;

            alert('Sistem ayarları başarıyla güncellendi!');
        }

        // Shortlink Ekleme
        async function addShortlink(title, url, bonkReward) {
            try {
                const data = await DATABASE.api.getAllData();
                if (!data.shortlinks) data.shortlinks = [];

                const newShortlink = {
                    id: Date.now(),
                    title,
                    url,
                    bonkReward: parseInt(bonkReward),
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    dailyLimit: ADMIN_CONFIG.dailyShortlinkLimit
                };

                data.shortlinks.push(newShortlink);
                await DATABASE.api.updateData(data);
                
                // Index sayfasına dinamik olarak ekle
                renderShortlinksOnIndex(data.shortlinks);
                
                alert('Shortlink başarıyla eklendi!');
            } catch (error) {
                console.error('Shortlink ekleme hatası:', error);
                alert('Shortlink eklenirken bir hata oluştu.');
            }
        }

        // PTC Ad Ekleme
        async function addPtcAd(title, url, bonkPerView) {
            try {
                const data = await DATABASE.api.getAllData();
                if (!data.ptcAds) data.ptcAds = [];

                const newPtcAd = {
                    id: Date.now(),
                    title,
                    url,
                    bonkPerView: parseInt(bonkPerView),
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    dailyLimit: ADMIN_CONFIG.dailyPtcAdLimit,
                    viewDuration: 15, // Default 15 saniye görüntüleme süresi
                    expirationDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 gün sonra sona erecek
                };

                data.ptcAds.push(newPtcAd);
                await DATABASE.api.updateData(data);
                
                // Index sayfasına dinamik olarak ekle
                renderPtcAdsOnIndex(data.ptcAds);
                
                alert('PTC Reklam başarıyla eklendi!');
            } catch (error) {
                console.error('PTC reklam ekleme hatası:', error);
                alert('PTC reklam eklenirken bir hata oluştu.');
            }
        }

        // Görev Ekleme
        async function addTask(title, description, bonkReward, type) {
            try {
                const data = await DATABASE.api.getAllData();
                if (!data.tasks) data.tasks = [];

                const newTask = {
                    id: Date.now(),
                    title,
                    description,
                    bonkReward: parseInt(bonkReward),
                    type,
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    expirationDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(), // 30 gün sonra sona erecek
                    completionLimit: 100 // Toplam tamamlanabilecek görev sayısı
                };

                data.tasks.push(newTask);
                await DATABASE.api.updateData(data);
                
                // Index sayfasına dinamik olarak ekle
                renderTasksOnIndex(data.tasks);
                
                alert('Görev başarıyla eklendi!');
            } catch (error) {
                console.error('Görev ekleme hatası:', error);
                alert('Görev eklenirken bir hata oluştu.');
            }
        }

        // İçerik Render Fonksiyonları
        function renderShortlinksOnIndex(shortlinks) {
            const shortlinksContainer = document.getElementById('shortlinksContainer');
            if (!shortlinksContainer) return;

            if (shortlinks && shortlinks.length > 0) {
                shortlinksContainer.innerHTML = shortlinks
                    .filter(sl => sl.status === 'active') // Sadece aktif shortlinkler
                    .map(link => `
                        <div class="bg-gray-100 p-4 rounded-lg mb-4 bonk-card">
                            <h4 class="font-semibold text-gray-800 mb-2">${link.title}</h4>
                            <div class="flex justify-between items-center">
                                <span class="text-green-600 font-medium">
                                    Çözme: ${link.bonkReward} BONK
                                </span>
                                <button onclick="openShortlink('${link.url}')" 
                                    class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition">
                                    Çöz
                                </button>
                            </div>
                        </div>
                    `).join('');
            } else {
                shortlinksContainer.innerHTML = '<p class="text-gray-600 text-center">Henüz shortlink yok.</p>';
            }
        }

        function renderPtcAdsOnIndex(ptcAds) {
            const ptcAdsContainer = document.getElementById('ptcAdsContainer');
            if (!ptcAdsContainer) return;

            if (ptcAds && ptcAds.length > 0) {
                ptcAdsContainer.innerHTML = ptcAds
                    .filter(ad => ad.status === 'active' && new Date(ad.expirationDate) > new Date()) // Aktif ve süresi dolmamış reklamlar
                    .map(ad => `
                        <div class="bg-gray-100 p-4 rounded-lg mb-4 bonk-card">
                            <h4 class="font-semibold text-gray-800 mb-2">${ad.title}</h4>
                            <div class="flex justify-between items-center">
                                <span class="text-green-600 font-medium">
                                    Görüntüleme: ${ad.bonkPerView} BONK
                                </span>
                                <button onclick="watchPtcAd('${ad.url}')"
                                    class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition">
                                    İzle
                                </button>
                            </div>
                        </div>
                    `).join('');
            } else {
                ptcAdsContainer.innerHTML = '<p class="text-gray-600 text-center">Henüz PTC reklam yok.</p>';
            }
        }

        function renderTasksOnIndex(tasks) {
            const tasksContainer = document.getElementById('tasksList');
            if (!tasksContainer) return;

            if (tasks && tasks.length > 0) {
                tasksContainer.innerHTML = tasks
                    .filter(task => task.status === 'active' && new Date(task.expirationDate) > new Date()) // Aktif ve süresi dolmamış görevler
                    .map(task => `
                        <div class="bg-gray-100 p-4 rounded-lg mb-4 bonk-card">
                            <h4 class="font-semibold text-gray-800 mb-2">${task.title}</h4>
                            <p class="text-gray-600 text-sm mb-2">${task.description}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-green-600 font-medium">
                                    ${task.bonkReward} BONK - ${task.type}
                                </span>
                                <button onclick="completeTask('${task.id}')" 
                                    class="bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition">
                                    Tamamla
                                </button>
                            </div>
                        </div>
                    `).join('');
            } else {
                tasksContainer.innerHTML = '<p class="text-gray-600 text-center">Henüz görev yok.</p>';
            }
        }

        // Form Gönderim İşleyicileri
        document.getElementById('shortlinkForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = this.querySelector('input[type="text"]').value;
            const url = this.querySelector('input[type="url"]').value;
            const bonkReward = this.querySelector('input[type="number"]').value;

            await addShortlink(title, url, bonkReward);
            closeModal('shortlinkModal');
            this.reset();
        });

        document.getElementById('ptcAdForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = this.querySelector('input[type="text"]').value;
            const url = this.querySelector('input[type="url"]').value;
            const bonkPerView = this.querySelector('input[type="number"]').value;

            await addPtcAd(title, url, bonkPerView);
            closeModal('ptcAdModal');
            this.reset();
        });

        document.getElementById('taskForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const title = this.querySelector('input[type="text"]').value;
            const description = this.querySelector('textarea').value;
            const bonkReward = this.querySelector('input[type="number"]').value;
            const type = this.querySelector('select').value;

            await addTask(title, description, bonkReward, type);
            closeModal('taskModal');
            this.reset();
        });

        // İstatistik Grafikleri Oluşturma
        async function createUserGrowthChart() {
            try {
                const stats = await DATABASE.stats.getGlobalStats();
                const ctx = document.getElementById('userGrowthChart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran'],
                        datasets: [{
                            label: 'Kullanıcı Sayısı',
                            data: [100, 250, 400, 600, 800, 1000],
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Aylık Kullanıcı Artışı'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Kullanıcı büyüme grafiği oluşturma hatası:', error);
            }
        }

        async function createEarningsChart() {
            try {
                const ctx = document.getElementById('earningsChart').getContext('2d');
                
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Shortlink', 'PTC Ads', 'Oyunlar', 'Görevler', 'Referanslar'],
                        datasets: [{
                            label: 'Toplam Kazanç (BONK)',
                            data: [5000, 3000, 2500, 1500, 1000],
                            backgroundColor: [
                                'rgba(54, 162, 235, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(153, 102, 255, 0.6)',
                                'rgba(255, 159, 64, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Kazanç Kaynakları'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Kazanç grafiği oluşturma hatası:', error);
            }
        }

        // Sayfa Yükleme İşlemleri
        document.addEventListener('DOMContentLoaded', async () => {
            // Giriş kontrolü
            const isLoggedIn = localStorage.getItem('adminAuth') === 'true';
            if (!isLoggedIn) {
                window.location.href = '/admin.html';
                return;
            }

            // Grafikleri oluştur
            createUserGrowthChart();
            createEarningsChart();

            // Mevcut verileri yükle
            const data = await DATABASE.api.getAllData();
            renderShortlinksOnIndex(data.shortlinks || []);
            renderPtcAdsOnIndex(data.ptcAds || []);
            renderTasksOnIndex(data.tasks || []);
        });

        // Çıkış İşlemi
        function logout() {
            localStorage.removeItem('adminAuth');
            window.location.href = '/admin.html';
        }
    </script>
</body>
</html>
